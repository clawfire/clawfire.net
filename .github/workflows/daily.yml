name: Trigger Netlify build if today matches

on:
  schedule:
    - cron: '5 0 * * *'
  workflow_dispatch:

jobs:
  check-and-trigger:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check for posts scheduled for today
        run: |
          TODAY=$(date '+%Y-%m-%d')
          echo "Checking for posts scheduled for: $TODAY"

          FUTURE_DATES=()

          # Scan all posts for future dates
          for FILE in _posts/*.md; do
            [ -f "$FILE" ] || continue
            POST_DATE=$(grep '^date:' "$FILE" | head -n1 | sed -E "s/date: *[\"']?([0-9]{4}-[0-9]{2}-[0-9]{2}).*/\1/")

            if [[ -n "$POST_DATE" ]] && [[ "$POST_DATE" > "$(date -d yesterday '+%Y-%m-%d')" ]]; then
              FUTURE_DATES+=("$POST_DATE")
              echo "  Found future post: $FILE → $POST_DATE"
            fi
          done

          if [ ${#FUTURE_DATES[@]} -eq 0 ]; then
            echo "Aucune build planifiée."
            exit 0
          fi

          NEXT_DATE=$(printf "%s\n" "${FUTURE_DATES[@]}" | sort | head -n1)
          echo "Prochaine build planifiée le: $NEXT_DATE"

          if [ "$NEXT_DATE" == "$TODAY" ]; then
            echo "✅ Build Netlify déclenchée pour aujourd'hui."
            curl -X POST -d '{}' "${{ secrets.NETLIFY_BUILD_HOOK }}"
          else
            echo "⏳ Rien à faire aujourd'hui. Prochaine build le $NEXT_DATE."
          fi
